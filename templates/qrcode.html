{% extends "base.html" %}

{% block title %}QR Code{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='qr.css') }}">

<div class="qr-code-container">
    <h2>QR Code</h2>
    {% if qr_code %}
        <p>Escaneie o QR Code abaixo para acessar sua conta ou informações:</p>
        <img src="{{ qr_code }}" alt="QR Code gerado" class="qr-code-image">
    {% elif error_message %}
        <p class="error">{{ error_message }}</p>
    {% else %}
        <p class="error">Erro desconhecido ao carregar o QR Code. Tente novamente.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
    const qrDisplay = document.getElementById('qr-code-display');
    const errorMessage = document.getElementById('error-message');
    const loadingMessage = document.createElement('p');

    // Adiciona uma mensagem inicial de carregamento
    loadingMessage.id = 'loading-message';
    loadingMessage.innerText = "Carregando QR Code, aguarde...";
    qrDisplay.appendChild(loadingMessage); // Exibe a mensagem enquanto o QR Code é carregado

    try {
        // Faz a requisição ao backend Flask para obter o QR Code
        const response = await fetch('/gerar_qr', { method: 'GET', cache: 'no-store' }); // Garante que não utilize cache
        if (!response.ok) throw new Error(`Erro na requisição: ${response.status} ${response.statusText}`);

        const data = await response.json();

        // Verifica e exibe o QR Code caso seja retornado com sucesso
        if (data.qr_code) {
            qrDisplay.innerHTML = `<img src="${data.qr_code}" alt="QR Code gerado" class="qr-code-image">`;
        } else {
            throw new Error("QR Code não encontrado na resposta do servidor.");
        }
    } catch (error) {
        // Exibe mensagem de erro ao usuário
        errorMessage.innerText = "Falha ao carregar o QR Code. Por favor, tente novamente mais tarde.";
        qrDisplay.innerHTML = ""; // Limpa o conteúdo do QR Code
        console.error("Erro detalhado:", error.message); // Loga o erro para depuração
    } finally {
        // Remove a mensagem de carregamento ao final
        if (loadingMessage) loadingMessage.remove();
    }
});
</script>
{% endblock %}
