{% extends "base.html" %}

{% block title %}Conectar Dispositivo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='qr.css') }}">

<div class="qr-code-container">
    <h2>Conectar Dispositivo</h2>
    <form id="connect-form">
        <label for="phone-input">Número de Telefone (com DDD):</label>
        <input type="text" id="phone-input" placeholder="+55 31 99999-9999" required>
        <button type="submit">Validar e Obter QR Code</button>
    </form>
    <div id="qr-code-display" class="hidden">
        <h3>Escaneie o QR Code abaixo:</h3>
    </div>
    <div id="status-message" class="hidden"></div>
    <div id="error-message" class="error-message"></div>
</div>

<style>
  #connect-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
  }

  #phone-input {
    padding: 10px;
    font-size: 16px;
  }

  button {
    padding: 10px;
    background-color: #3498db;
    color: white;
    border: none;
    cursor: pointer;
  }

  .hidden {
    display: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('connect-form');
      const phoneInput = document.getElementById('phone-input');
      const qrDisplay = document.getElementById('qr-code-display');
      const statusMessage = document.getElementById('status-message');
      const errorMessage = document.getElementById('error-message');

      form.addEventListener('submit', async function (event) {
          event.preventDefault();

          const phoneNumber = phoneInput.value.trim();
          if (!phoneNumber) {
              alert("Por favor, insira um número de telefone válido!");
              return;
          }

          try {
              const email = prompt("Digite seu email para prosseguir:");
              if (!email) return;

              // Valida telefone e obtém QR Code
              const response = await fetch(`/connect-client`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ email, phone })
              });

              const data = await response.json();

              if (response.ok) {
                  statusMessage.textContent = "Número de telefone validado com sucesso! Escaneie o QR Code abaixo.";
                  statusMessage.classList.remove("hidden");
                  qrDisplay.innerHTML = `<img src="/generate-qr" alt="QR Code Global">`;
                  qrDisplay.classList.remove("hidden");
                  form.classList.add("hidden"); // Esconde o formulário após validação
              } else {
                  throw new Error(data.error || "Erro ao validar número de telefone.");
              }
          } catch (error) {
              console.error("Erro ao conectar cliente:", error.message);
              errorMessage.textContent = "Erro ao validar número. Por favor, tente novamente.";
          }
      });
  });
</script>
{% endblock %}
