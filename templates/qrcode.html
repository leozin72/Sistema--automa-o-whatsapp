{% extends "base.html" %}

{% block title %}Conectar Dispositivo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='qr.css') }}">

<div class="qr-code-container">
    <h2>Conectar Dispositivo</h2>
    <div id="qr-code-display"></div>
    <div id="status-message" class="hidden"></div>
    <div id="error-message" class="error-message"></div>
</div>

<style>
  /* Estilo adicional para mensagens e botões */
  .hidden {
    display: none; /* Esconde elementos */
  }

  #status-message {
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
    color: green; /* Destaca mensagens de sucesso */
  }

  .error-message {
    color: red;
    font-size: 16px;
    margin-top: 10px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async function () {
      const qrDisplay = document.getElementById('qr-code-display');
      const statusMessage = document.getElementById('status-message');
      const errorMessage = document.getElementById('error-message');

      try {
          let attempts = 0;
          const maxAttempts = 50; // Aumenta número de tentativas para garantir carregamento
          let isConnected = false;

          while (attempts < maxAttempts && !isConnected) {
              const response = await fetch('/gerar_qr', { method: 'GET', cache: 'no-store' });

              if (response.status === 202) {
                  console.log(`Tentativa ${attempts + 1}: QR Code ainda não gerado.`);
                  attempts++;
                  await new Promise(resolve => setTimeout(resolve, 3000));
              } else if (response.ok) {
                  const data = await response.json();
                  console.log("Dados recebidos do backend:", data);

                  if (data.qr_code) {
                      qrDisplay.innerHTML = `<img src="${data.qr_code}" alt="QR Code para conexão" class="qr-code-image">`;
                      statusMessage.classList.add("hidden");
                  } else if (data.message === "Cliente conectado") {
                      statusMessage.textContent = "Seu WhatsApp está conectado com sucesso!";
                      statusMessage.classList.remove("hidden");
                      qrDisplay.classList.add("hidden");
                      isConnected = true;
                  } else {
                      throw new Error("QR Code ou estado de conexão não encontrado na resposta do backend.");
                  }
              } else {
                  throw new Error(`Erro HTTP: ${response.status}`);
              }
          }

          if (!isConnected && attempts === maxAttempts) {
              throw new Error("QR Code não foi gerado dentro do tempo esperado.");
          }
      } catch (error) {
          console.error("Erro ao carregar o QR Code:", error.message);
          errorMessage.innerText = "Erro ao carregar o QR Code. Por favor, tente novamente mais tarde.";
          qrDisplay.innerHTML = ""; // Limpa o conteúdo do QR Code
      }
  });
</script>
{% endblock %}
