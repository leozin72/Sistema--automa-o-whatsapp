{% extends "base.html" %}

{% block title %}Conectar Dispositivo{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='qr.css') }}">

<div class="qr-code-container">
    <h2>Conectar Dispositivo</h2>
    <div id="qr-code-display">
        <p>Escaneie o QR Code abaixo para conectar seu dispositivo ao sistema:</p>
        <img id="qr-code-image" src="" alt="QR Code Global" class="qr-code-image">
    </div>
    <div id="status-message" class="hidden"></div>
    <div id="error-message" class="error-message hidden"></div>
</div>

<style>
  .qr-code-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    margin-top: 20px;
  }

  .qr-code-image {
    max-width: 300px;
    margin-top: 15px;
  }

  .hidden {
    display: none;
  }

  #status-message {
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
    color: green;
  }

  .error-message {
    color: red;
    font-size: 16px;
    margin-top: 10px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async function () {
      const qrImage = document.getElementById('qr-code-image');
      const statusMessage = document.getElementById('status-message');
      const errorMessage = document.getElementById('error-message');

      try {
          // Chama o endpoint para buscar o QR Code global
          const response = await fetch('https://sistema-automa-o-whatsapp.onrender.com/generate-qr/:email:', { method: 'GET', cache: 'no-store' });

          if (response.ok) {
              const data = await response.json();
              qrImage.src = data.qr_code; // Define o QR Code recebido como a imagem
              qrImage.classList.remove("hidden");
              statusMessage.textContent = "Escaneie o QR Code para conectar seu dispositivo!";
              statusMessage.classList.remove("hidden");
          } else {
              throw new Error("QR Code ainda n√£o gerado. Por favor, tente novamente.");
          }
      } catch (error) {
          console.error("Erro ao carregar QR Code:", error.message);
          errorMessage.textContent = "Erro ao carregar QR Code. Tente novamente mais tarde.";
          errorMessage.classList.remove("hidden");
      }
  });
</script>
{% endblock %}
